# 更新日志 (CHANGELOG)

## 2026-01-30

### 🔧 真机兼容性修复
**解决微信小游戏真机环境显示空白问题**

- **配置文件模块化修复**
  - ✅ `gameConfig.js` 和 `resourceConfig.js` 从 `module.exports` 改为 `export default`
  - ✅ `ConfigManager.js` 从 `require()` 改为 `import`
  - ✅ `World.js` 实体创建从 `require()` 改为 `import`
  - **原因**: 微信小游戏只支持ES6模块语法,不支持Node.js的CommonJS语法

- **🎯 ECS组件系统核心修复** (最关键)
  - **问题**: Entity使用类名字符串作为Map的key,真机代码压缩后类名变成单字母导致组件获取失败
  - **修复**: Map的key从**类名字符串**改为**类引用本身**
  - **影响**: 所有组件(PositionComponent、RenderComponent等)在真机上都能正常工作
  ```javascript
  // ❌ 修复前: 使用类名字符串(真机压缩后会变)
  this.components.set(component.constructor.name, component);
  
  // ✅ 修复后: 使用类引用本身(不受压缩影响)
  this.components.set(component.constructor, component);
  ```

- **RenderSystem文本渲染优化**
  - 兼容 `textAlign` 和 `align` 两种属性名
  - 确保文本对齐方式正确应用

- **文档更新**
  - 新增"真机上一片空白"常见问题解答
  - 补充微信小游戏环境注意事项
  - 强调代码压缩问题和ES6模块规范

**技术要点**:
- 微信小游戏真机会压缩代码,类名会变成单字母(a、b、c等)
- 必须使用类引用本身而非类名字符串作为Map的key
- 只能使用ES6模块(`import`/`export`),不能使用CommonJS(`require`/`module.exports`)

---

## 2026-01-29

### 🎒 物品栏动态顺序优化
**✨ 物品栏改为按收集顺序动态显示**

根据游戏体验优化,物品栏不再使用固定位置,而是像真正的RPG背包一样按收集顺序显示:

- **动态物品栏系统**
  - **改变前**: 物品栏预留固定位置(金币、种子、石块、土块)
  - **改变后**: 按照**收集的先后顺序**动态添加物品
  - **数据结构**: 从`Map`改为`Array`,记录收集时间戳
  - **好处**: 更符合真实游戏体验,玩家能看到收集历史
  
- **多行布局支持**
  - 自动计算每行可显示的物品数量
  - 支持多行换行显示,不受物品数量限制
  - 点击检测适配多行布局
  
- **UI显示优化**
  - 空物品栏显示友好提示:"物品栏空空如也..."
  - 标题改为"物品栏 (按收集顺序)"
  - 底部显示:"共X种物品 | 总计Y个"
  - 数量显示改为 "×3" 格式,更清晰
  
- **InventoryComponent重构**
  ```javascript
  // 之前: 固定顺序的Map
  items = new Map([
    ['coin', 5],
    ['seed', 3]
  ])
  
  // 现在: 按时间排序的Array
  items = [
    {type: 'coin', count: 5, timestamp: 1706505600000},
    {type: 'seed', count: 3, timestamp: 1706505630000}
  ]
  ```

**收集体验示例**:
```
1. 收集第1个金币 → 物品栏: [金币×1]
2. 收集第1个种子 → 物品栏: [金币×1, 种子×1]
3. 收集第2个金币 → 物品栏: [金币×2, 种子×1]
4. 收集第1个石块 → 物品栏: [金币×2, 种子×1, 石块×1]
```

每个物品的位置反映了你的探索历程!🗺️✨

---

### 🔧 物品渲染系统修复
**🐛 修复了物品不显示的问题**

经过调试,发现并修复了物品无法在地图上显示的关键问题:

- **RenderSystem组件要求修复**
  - **问题**: RenderSystem的`requiredComponents`设置为`[PositionComponent, RenderComponent]`
  - **影响**: 物品实体只有`PositionComponent`和`ItemComponent`,没有`RenderComponent`,导致它们不会被传递给渲染系统
  - **修复**: 改为只需要`[PositionComponent]`,让所有有位置的实体都能被渲染
  
- **物品渲染逻辑优化**
  - 在render方法中优先检查`ItemComponent`,如果存在就使用专用的物品渲染
  - 添加cellSize参数到RenderSystem构造函数,支持动态物品大小计算
  - 修复硬编码的cellSize=50问题,改为使用配置中的实际值
  
- **初始化顺序修复**
  - **问题**: `_initializeItemGeneration()`在`_createTerrain()`中调用,但此时玩家还未创建
  - **修复**: 移到`_createPlayer()`之后调用,确保玩家实体存在
  - **结果**: 物品生成器能正确获取玩家位置,设置禁止生成区域

- **性能优化**
  - 添加空值检查,避免渲染过程中的错误
  - 优化排序逻辑,正确处理没有RenderComponent的实体
  - 改进透明度处理,使用Canvas的save/restore机制

**修复后的效果**:
```
现在游戏启动后会看到:
- 🪙 金色圆形的金币(带内部高光特效)
- 🌱 棕色菱形的种子(中间有装饰小点)
- 物品散布在可行走的陆地区域
- 玩家周围3格内不会有物品
```

---

### 🎁 物品收集系统重大更新
**🪙 全新物品收集系统 - 让游戏更有趣!**

这是一次重要的游戏性更新,为网格移动游戏引入了完整的物品收集系统!

- **智能物品生成系统**
  - 实现了ItemGenerator物品生成器,可以在地图上随机生成金币和种子
  - 支持地形感知生成:物品只会出现在可行走的陆地上,不会生成在水域
  - 智能避让:玩家起始位置周围3格范围内不会生成物品,确保游戏体验
  - 可配置生成数量:金币8个,种子6个,分布在30×30的大地图上

- **动态物品栏系统**
  - 重构UIManager,移除硬编码的剑、盾等物品
  - 实现InventoryComponent组件,支持动态物品数据管理
  - 美观的UI显示:使用emoji图标(🪙🌱)和数量显示
  - 实时更新:收集物品后物品栏立即更新显示

- **精确碰撞检测**
  - 实现CollectionSystem收集系统,处理玩家与物品的交互
  - 精确碰撞:只有角色到达格子中心才能收集物品,不是边缘碰撞
  - 复用现有GridSystem的格子中心检测逻辑(distance < 3像素)
  - 收集反馈:音效提示、控制台消息、UI更新

- **精美物品渲染**
  - 扩展RenderSystem支持物品渲染
  - 金币:金色圆形,带有内部高光特效
  - 种子:棕色菱形,中间有小点装饰
  - 支持透明度渐变收集特效
  - 不同形状:圆形、方形、菱形可扩展

- **可扩展架构设计**
  - 基于ECS架构,完美集成现有系统
  - ItemComponent支持多种物品类型:收集型、阻挡型、地形属性型
  - 为未来功能预留接口:石块(阻挡移动)、土块(地形属性)
  - 模块化设计,易于添加新物品类型

- **性能优化**
  - 空间分区:使用网格坐标快速定位物品
  - 智能渲染:已收集物品自动隐藏,减少绘制开销
  - 内存管理:支持已收集物品的清理机制
  - 批量操作:物品生成和UI更新都经过优化

**技术架构**:
```
新增组件和系统:
├── ItemComponent.js          # 物品属性和状态管理
├── InventoryComponent.js     # 玩家物品栏数据
├── CollectionSystem.js       # 收集逻辑和碰撞检测
├── ItemGenerator.js          # 物品生成和配置
└── UIManager.js (重构)       # 动态物品栏显示

集成现有系统:
├── RenderSystem.js (扩展)    # 支持物品渲染
├── GridMoveGame.js (更新)    # 系统注册和初始化
└── 与地形系统完美集成        # 物品只生成在可行走区域
```

---

### 🎨 动画系统优化
**修复眼睛抖动和增强呼吸效果**

针对用户反馈的动画问题进行了精细优化:

- **修复眼睛抖动问题**
  - 将头部和眼睛位置固定,不再随身体移动
  - 走路时只有身体和四肢会摆动,头部保持稳定
  - 眼睛坐标统一使用相对头部中心的定位系统
  - 移动动画更加自然流畅

- **增强站立呼吸效果**
  - 改进呼吸动画算法,使用明确的身体缩放参数
  - frame 0: 正常状态
  - frame 1: 吸气状态(身体纵向拉伸10%,上移1像素)
  - frame 2: 呼气状态(身体纵向压缩5%,下移1像素)
  - 呼吸节奏更加明显,视觉效果显著提升

- **代码架构优化**
  - 重构`_drawCharacterBase()`方法,支持参数化的身体缩放和偏移
  - 新增`_drawLimbsWalking()`方法,专门处理走路时的四肢摆动
  - 删除过时的`_applyBreathEffect()`和`_applyWalkEffect()`方法
  - 代码更加清晰易读,维护性更好

- **动画细节改进**
  - 走路动画的四肢摆动幅度调整为±3像素
  - 身体上下摆动幅度保持±2像素
  - 手臂和腿部使用相反的摆动相位,模拟真实走路动作
  - 所有动画参数都经过精心调校

---

### 🎬 角色动画系统重大更新
**🎨 全新角色动画系统 - 让游戏角色栩栩如生!**

这是一次革命性的更新,为网格移动游戏引入了完整的角色动画系统!

- **智能动画生成**
  - 实现了SpriteGenerator精灵图生成器,可以程序化生成角色动画帧
  - 支持走路动画(4帧)和站立呼吸动画(3帧)
  - 支持四个方向(上下左右)的完整动画序列
  - 48x48像素的精美像素风格角色设计

- **状态驱动动画系统**
  - 新增AnimationComponent组件,管理动画状态和帧切换逻辑
  - 新增AnimationSystem系统,根据角色移动状态自动切换动画
  - 支持动画循环播放、帧率控制、方向切换
  - 与现有MovementSystem完美集成,实现智能动画切换

- **资源管理优化**
  - 实现ImageLoader图片加载器,提供异步加载和缓存管理
  - 支持批量图片预加载,优化游戏启动性能
  - 内存使用监控和资源清理机制
  - 微信小游戏环境完美兼容

- **完善的测试系统**
  - 实现AnimationTester动画测试器,确保系统稳定性
  - 自动化测试覆盖动画生成、组件初始化、系统集成等
  - 手动测试功能,支持各种动画状态的验证
  - 详细的测试报告和错误诊断

- **架构升级**
  ```
  新增核心组件:
  ├── AnimationComponent.js     # 动画状态管理
  ├── AnimationSystem.js        # 动画逻辑处理
  ├── SpriteGenerator.js        # 动画图片生成
  ├── ImageLoader.js            # 资源加载管理
  └── AnimationTester.js        # 测试验证工具
  
  系统集成:
  MovementSystem → AnimationSystem → RenderSystem
  ```

- **性能优化**
  - 离屏Canvas预渲染技术,减少实时绘制开销
  - 智能状态缓存,避免重复的动画切换计算
  - 帧率自适应控制,平衡视觉效果和性能消耗

- **用户体验提升**
  - 角色移动时播放流畅的走路动画
  - 静止时播放自然的呼吸动画
  - 方向切换时动画无缝过渡
  - UI界面显示当前动画状态信息

---

### 🐛 移动系统问题修复
**重要修复: 解决移动停顿和坐标跳跃问题**

修复了两个严重影响游戏体验的移动系统bug:

- **问题1: 移动停顿感**
  - **原因**: GridSystem和DragSystem使用不同的距离阈值判断是否到达目标
  - **现象**: 角色移动时会出现明显的停顿,不流畅
  - **修复**:
    - 统一GridSystem和DragSystem的距离阈值为3像素
    - GridSystem从1像素提高到3像素,减少过早触发对齐
    - DragSystem从5像素降低到3像素,保持一致性

- **问题2: 纵向坐标突然改变**
  - **原因**: GridSystem使用`Math.round`计算网格坐标
  - **现象**: 向左移动时,纵向坐标会突然跳到另一行
  - **根本原因**: 当角色纵向位置稍微偏离中心时(比如25.6),`Math.round(25.6/50)=1`会错误地四舍五入到下一行
  - **修复**:
    - 改用目标位置计算网格坐标:`Math.floor(targetX / cellSize)`
    - 直接对齐到目标位置,不重新计算中心点
    - 保证移动方向的稳定性

- **MovementSystem优化**
  - 使用归一化方向向量保持移动方向稳定
  - 降低到达目标的阈值到0.5像素,提高精确度
  - 避免因浮点数误差导致的方向偏移

---

### 🌊 地形系统重大更新
**地形系统全面实现 - 游戏世界更加真实!**

这是一次革命性的更新,为网格移动游戏引入了完整的地形系统!

- **地形类型系统**
  - 实现了水格子(蓝色,不可行走)和土格子(棕色,可行走)
  - 属性驱动架构:每种地形都有 `walkable` 属性
  - 易于扩展:未来可轻松添加山地、森林、沙漠等新地形

- **智能随机地图生成**
  - 圆形岛屿算法:从中心向外扩展形成自然的陆地形状
  - 连通性保证:使用BFS算法确保所有陆地相互连通,无孤岛
  - 边缘水域控制:地图外围2-5格范围合理分布水域
  - 可配置参数:陆地比例、中心半径、边缘范围等

- **预判断移动系统**
  - 智能移动检查:拖拽时立即计算目标格子是否可行走
  - 即时反馈:尝试移动到水域时立即阻止,显示"阻挡"状态
  - 性能优化:基于网格坐标计算,避免像素级检查

- **玩家体验优化**
  - 智能起始位置:自动寻找可行走的起始点
  - 螺旋搜索算法:如果中心被水覆盖,向外搜索合适位置
  - 视觉差异化:水域和陆地有明显的颜色区别和边框效果

- **技术架构升级**
  ```
  新增组件和系统:
  ├── TerrainComponent.js     # 地形数据管理
  ├── TerrainSystem.js        # 地形渲染和验证
  ├── MapGenerator.js         # 随机地图生成器
  └── TerrainTypes.js         # 地形类型定义
  
  集成现有系统:
  ├── DragSystem.js          # 添加地形检查
  ├── GridSystem.js          # 添加安全验证
  └── GridMoveGame.js        # 系统集成
  ```

- **配置系统扩展**
  - 新增 `terrain` 配置节点
  - 可调参数:`landRatio`, `centerRadius`, `edgeWaterRange`
  - 调试选项:`visualizeInConsole` 在控制台显示地图

- **渲染性能优化**
  - 离屏Canvas预渲染:地形背景只渲染一次
  - 缓存机制:避免每帧重绘地形
  - 微信小游戏兼容:支持微信环境的Canvas创建

---

### 🎨 GridMove游戏UI全面升级

- **底部UI区域重新设计**
  - 返回按钮移至底部左侧,更方便操作
  - 实现了Tab切换系统,支持多页面内容展示
  - 底部UI背景半透明深色,更有科技感
  
- **多Tab界面实现**
  - **信息Tab**: 显示角色的详细信息
    - 网格坐标 (gridX, gridY)
    - 像素位置 (x, y)
    - 移动方向(上/下/左/右/无)
    - 移动状态(是/否)
  - **物品Tab**: 物品栏系统(为后续功能做准备)
    - 单行可翻页的物品按钮展示
    - 支持物品选中(点击高亮显示)
    - 空物品栏显示为灰色
    - 非空物品可点击选中使用
    
- **触摸控制优化**
  - 在底部UI区域按下不会触发拖动移动
  - UI点击与游戏拖动完全分离
  - 点击返回按钮/Tab/物品都有响应
  
- **新增UIManager组件**
  - 统一管理所有UI元素的绘制和交互
  - 支持Tab切换、按钮点击、物品选择
  - 易于扩展,后续可以轻松添加更多UI功能

---

### 📐 游戏区域布局调整

- **网格限制显示在屏幕中间偏上的区域**
  - 顶部空出100像素(可以放标题、分数等)
  - 底部空出300像素(可以放控制按钮、信息面板等)
  - 网格只在中间区域显示,不会占满全屏
  - 使用 `clip()` 裁剪,网格不会溢出到UI区域
  
- **优化摄像机和坐标系统**
  - 摄像机计算基于游戏区域尺寸,而不是整个屏幕
  - 玩家在游戏区域内居中显示
  - 绘制了游戏区域边框(灰色边框)便于识别范围

---

### 🐛 各种移动系统Bug修复

- **修复移动中突然返回之前格子的bug**
  - 问题原因:每帧都更新 `grid.gridX/gridY`,导致移动中目标突变
  - 修复方案:只在关键时刻更新网格坐标(格子中心/停止时)
  
- **修复松手瞬移问题**
  - 问题:松手时调用 `_snapToGridCenter()` 会瞬间跳到格子中心
  - 修复:移除强制对齐,改为自然停止
  
- **修复拖动卡死bug**
  - 问题:松手时角色可能停在"接近但不完全在"格子中心的位置
  - 修复:松手时强制对齐到最近的格子中心
  
- **修复GridComponent坐标不更新的问题**
  - 新增 `_updateGridPosition()` 方法实时更新网格坐标
  
- **修复方向切换延迟问题**
  - 重构update逻辑:在格子中心才响应方向,其他时间保持当前移动

---

### 🔍 视野和网格调整

- **扩大视野显示更多网格**
  - `gridSize`: 5 → 20 → 30
  - `cellSize`: 300 → 150 → 80 → 50
  - `playerSpeed`: 相应调整
  - 现在可以看到更广阔的世界!

---

### ✅ 其他优化

- **拖拽线优化**
  - 修复拖拽线刚按下就显示的问题
  - 只有拖动距离超过10像素才显示连线
  
- **角色大小调整**
  - 角色大小与网格匹配,完美填充网格
  - 限制角色在有效网格范围内移动
  
- **方向判断修复**
  - 修复方向显示与实际移动不一致的bug
  - 保持从按下点计算方向,不在移动过程中重置起点
  
- **调试信息增强**
  - 添加角色网格信息显示
  - 显示网格坐标、像素位置、移动状态
  - 方向调试显示(屏幕下方中间)

---

## 早期版本

### 网格移动游戏初始版本
- ✅ 实现基于网格的移动系统
- ✅ 添加拖拽方向线提示(金色线条)
- ✅ 实现摄像机跟随角色移动
- ✅ 修复返回按钮无响应的问题
